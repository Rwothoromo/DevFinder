version: 2.1

orbs:
  android: circleci/android@3.1.0
#  gcp-cli: circleci/gcp-cli@3.3.1

# Reusable commands / repeat tasks
commands:
  export_google_services_key:
    steps:
      - run:
          name: Export Google Services key environment variable
          command: echo 'export GOOGLE_SERVICES_JSON="$GOOGLE_SERVICES_JSON"' >> $BASH_ENV

  decode_google_services_key:
    steps:
      - run:
          name: Decode Google Services JSON key
          command: |
            sudo chmod 600 /root/.
            sudo mkdir -m 0755 -p app/src/mock/
            sudo mkdir -m 0755 -p app/src/prod/
            sudo touch -m 0755 app/google-services.json
            sudo touch -m 0755 app/src/mock/google-services.json
            sudo touch -m 0755 app/src/prod/google-services.json
            sudo chmod 777 app/google-services.json
            sudo chmod 777 app/src/mock/google-services.json
            sudo chmod 777 app/src/prod/google-services.json
            sudo echo $GOOGLE_SERVICES_JSON | base64 --decode > app/google-services.json
            sudo echo $GOOGLE_SERVICES_JSON | base64 --decode > app/src/mock/google-services.json
            sudo echo $GOOGLE_SERVICES_JSON | base64 --decode > app/src/prod/google-services.json
      - run: ls -l app/google-services.json

  export_keystore_key:
    steps:
      - run:
          name: Set the KEYSTORE environment variable to itâ€™s location.
          command: echo 'export KEYSTORE=~/project/keystores/keystore.jks' >> $BASH_ENV
      - run: ls -l ~/project/keystores/keystore.jks

  decode_keystore_key:
    steps:
      - run:
          name: Decode the base64 encoded text back into the keystore.jks file
          command: |
            sudo mkdir -m 0755 -p ~/project/keystores/
            sudo chmod 777 ~/project/keystores/
            echo $ENCODED_KEYSTORE | base64 --decode >> ~/project/keystores/keystore.jks
      - run: ls -l ~/project/keystores/keystore.jks

  save_gradle_cache:
    steps:
      - save_cache:
          paths:
            - ~/.gradle
          key: v3-gradle-{{ checksum "build.gradle" }}

  restore_gradle_cache:
    steps:
      - restore_cache:
          keys:
            - v3-gradle-{{ checksum "build.gradle" }}


jobs:
  #  use-gcp:
  #    executor: gcp-cli/default
  #    steps:
  #      - gcp-cli/setup:
  #          version: 404.0.0

  quality_check:
    executor:
      name: android/android_machine
      resource_class: large
      tag: default
    steps:
      - checkout
      - attach_workspace:
          at: ~/
      - run: ls -l
      - export_google_services_key
      - decode_google_services_key
      - restore_gradle_cache
      - run: ./gradlew dependencies --warning-mode all
      - run: ./gradlew checkstyle pmd lint
      - save_gradle_cache


  unit_tests:
    executor:
      name: android/android_machine
      tag: default
    parallelism: 4
    steps:
      - checkout
      - attach_workspace:
          at: ~/
      - run: ls -l
      - export_google_services_key
      - decode_google_services_key
      - restore_gradle_cache
      - run: ./gradlew dependencies --warning-mode all
      - android/run_tests:
          test_command: ./gradlew testMockDebugUnitTest | circleci tests glob "app/src/test/**/*Test.kt" | circleci tests run --command="echo" --verbose --split-by=timings --timings-type=classname
      - run: ls -l && pwd
      - persist_to_workspace:
          root: ~/project
          paths:
            - app/build/intermediates
            - app/build/outputs/androidTest-results
            - app/build/outputs/apk
            - app/build/outputs/code-coverage
            - app/build/test-results
            - app/build/reports
            - app/build/reports/androidTests
            - app/build/reports/tests
            - firebase
      - run:
          name: Save test results
          command: |
            sudo mkdir -m 0755 -p ~/test-results/junit/
            sudo chmod 777 ~/test-results/junit/
            find . -type f -regex ".*/build/test-results/.*xml" -exec cp {} ~/test-results/junit/ \;
          when: always
      - run: ls -l ~/test-results/junit/
      - store_test_results:
          path: ~/test-results
      - store_artifacts:
          path: ~/test-results/junit
      - save_gradle_cache


  android_tests:
    executor:
      name: android/android_machine
      tag: default
    parallelism: 4
    steps:
      - checkout
      - attach_workspace:
          at: ~/
      - run: ls -l
      - export_google_services_key
      - decode_google_services_key
#      - run:
#          name: Create avd
#          command: |
#            SYSTEM_IMAGES="system-images;android-29;default;x86"
#            sdkmanager "$SYSTEM_IMAGES"
#            echo "no" | avdmanager --verbose create avd -n test -k "$SYSTEM_IMAGES"
#      - run:
#          name: Launch emulator
#          command: |
#            emulator -avd test -delay-adb -verbose -no-window -gpu swiftshader_indirect -no-snapshot -noaudio -no-boot-anim
#          background: true
#      - run:
#          name: Generate cache key
#          command: |
#            find . -name 'build.gradle' | sort | xargs cat |
#            shasum | awk '{print $1}' > /tmp/gradle_cache_seed
#      - restore_cache:
#          key: gradle-v1-{{ arch }}-{{ checksum "/tmp/gradle_cache_seed" }}
#      - run:
#          # run in parallel with the emulator starting up, to optimize build time
#          name: Run assembleDebugAndroidTest task
#          command: |
#            ./gradlew connectedMockDebugAndroidTest | circleci tests glob "app/src/androidTest/**/*InstrumentationTest.kt" | circleci tests run --command="echo" --verbose --split-by=timings --timings-type=classname
#      - run:
#          name: Wait for emulator to start
#          command: |
#            circle-android wait-for-boot
#      - run:
#          name: Disable emulator animations
#          command: |
#            adb shell settings put global window_animation_scale 0.0
#            adb shell settings put global transition_animation_scale 0.0
#            adb shell settings put global animator_duration_scale 0.0
#      - run:
#          name: Run UI tests (with retry)
#          command: |
#            MAX_TRIES=2
#            run_with_retry() {
#               n=1
#               until [ $n -gt $MAX_TRIES ]
#               do
#                  echo "Starting test attempt $n"
#                  ./gradlew connectedAndroidTest && break
#                  n=$[$n+1]
#                  sleep 5
#               done
#               if [ $n -gt $MAX_TRIES ]; then
#                 echo "Max tries reached ($MAX_TRIES)"
#                 exit 1
#               fi
#            }
#            run_with_retry
#      - save_cache:
#          key: gradle-v1-{{ arch }}-{{ checksum "/tmp/gradle_cache_seed" }}
#          paths:
#            - ~/.gradle/caches
#            - ~/.gradle/wrapper
#      - store_test_results:
#          path: app\build\outputs\androidTest-results
      - run:
          name: Installing emulator and Running Instrumentation tests
          command: |
            sdkmanager "platform-tools" "platforms;android-29" "build-tools;30.0.0" "emulator"
            sdkmanager "system-images;android-29;google_apis;x86"
            echo no | avdmanager create avd -n test-emulator -k  "system-images;android-29;google_apis;x86"
            emulator -avd test-emulator -noaudio -no-boot-anim -gpu off -no-window &
            adb wait-for-device shell 'while [[ -z $(getprop sys.boot_completed) ]]; do sleep 1; done;'
            adb shell wm dismiss-keyguard
            sleep 1
            adb shell settings put global window_animation_scale 0
            adb shell settings put global transition_animation_scale 0
            adb shell settings put global animator_duration_scale 0
            ./gradlew connectedMockDebugAndroidTest | circleci tests glob "app/src/androidTest/**/*InstrumentationTest.kt" | circleci tests run --command="echo" --verbose --split-by=timings --timings-type=classname


  jacoco_code_coverage:
    executor:
      name: android/android_machine
      tag: default
    steps:
      - checkout
      - export_google_services_key
      - decode_google_services_key
      - decode_keystore_key
      - export_keystore_key
      - restore_gradle_cache
      - run: ./gradlew dependencies --warning-mode all
      - run:
          name: Create directory to store test results
          command: mkdir firebase
      - run: ls -l ~/project/firebase/
      - run:
          name: Move Firebase coverage report
          command: |
            sudo mkdir -m 0755 -p app/build/outputs/code-coverage/connected/flavors/MOCK
            sudo chmod 777 app/build/outputs/code-coverage/connected/flavors/MOCK
            cp firebase/sailfish-26-en_US-portrait/artifacts/coverage.ec app/build/outputs/code-coverage/connected/flavors/MOCK/coverage.ec
      - run:
          name: Code Climate Test Setup
          command: |
            curl -L https://codeclimate.com/downloads/test-reporter/test-reporter-latest-linux-amd64 > ./cc-test-reporter
            chmod +x ./cc-test-reporter
      - run:
          name: Code Climate Pretest
          command: ./cc-test-reporter before-build
      - run:
          name: Generate JaCoCo report
          command: ./gradlew jacocoTestReport
      - run:
          name: Upload coverage to code climate
          command: |
            export JACOCO_SOURCE_PATH=app/src/main/java
            ./cc-test-reporter format-coverage app/build/reports/jacocoTestReport/jacocoTestReport.xml -t jacoco
            ./cc-test-reporter upload-coverage
      - store_artifacts:
          path: app/build/reports/
          destination: /reports/
      - save_gradle_cache


  release_build:
    executor:
      name: android/android_machine
      tag: default
    steps:
      - checkout
      - export_google_services_key
      - decode_google_services_key
      - decode_keystore_key
      - export_keystore_key
      - restore_gradle_cache
      - run:
          name: Assemble release build
          command: |
            ./gradlew assembleRelease --warning-mode all
      - run: ls -l app/
      - store_artifacts:
          path: app/prod/release/app-prod-release.apk
      - save_gradle_cache


workflows:
  build_test_deploy:
    jobs:
      - quality_check

#      - unit_tests:
#          requires:
#            - build
      - android_tests: # No connected devices!
          requires:
#            - unit_tests
            - quality_check
#      - jacoco_code_coverage:
#          requires:
#            - android_tests
#      - release_build:
#          requires:
##            - jacoco_code_coverage
#            - unit_tests

#  install_and_configure_cli:
#    jobs:
#      - use-gcp:
#          context: myContext
